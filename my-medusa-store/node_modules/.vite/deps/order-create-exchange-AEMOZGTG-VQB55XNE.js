import {
  useAddExchangeInboundItems,
  useAddExchangeInboundShipping,
  useAddExchangeOutboundItems,
  useAddExchangeOutboundShipping,
  useCancelExchangeRequest,
  useCreateExchange,
  useDeleteExchangeInboundShipping,
  useDeleteExchangeOutboundShipping,
  useExchange,
  useExchangeConfirmRequest,
  useRemoveExchangeInboundItem,
  useRemoveExchangeOutboundItem,
  useUpdateExchangeInboundItem,
  useUpdateExchangeInboundShipping,
  useUpdateExchangeOutboundItems,
  useUpdateExchangeOutboundShipping
} from "./chunk-AU7UJI5R.js";
import {
  ItemPlaceholder
} from "./chunk-WZHDB5JF.js";
import {
  OutboundShippingPlaceholder,
  ReturnShippingPlaceholder
} from "./chunk-YD5FTRQU.js";
import {
  MoneyAmountCell
} from "./chunk-3H5J2KKL.js";
import {
  getReturnableQuantity
} from "./chunk-PM26KX6Y.js";
import {
  DEFAULT_FIELDS
} from "./chunk-O57C3MAB.js";
import {
  useReturn,
  useUpdateReturn
} from "./chunk-RNAOBBSK.js";
import {
  getStylizedAmount
} from "./chunk-UDMOPZAP.js";
import {
  ProductCell,
  ProductHeader
} from "./chunk-GBWIHZ5H.js";
import "./chunk-EGRHWZRV.js";
import "./chunk-S5JEKJNE.js";
import {
  _DataTable,
  useDataTable
} from "./chunk-7G6GEV6X.js";
import "./chunk-HF5QS2DS.js";
import "./chunk-UHVTGAAG.js";
import "./chunk-HNSNBECS.js";
import {
  currencies
} from "./chunk-H3DTEG3J.js";
import {
  Combobox
} from "./chunk-BGF3KVQR.js";
import {
  KeyboundForm
} from "./chunk-DP54EP6X.js";
import {
  useQueryParams
} from "./chunk-32T72GVU.js";
import "./chunk-MNX57DI6.js";
import "./chunk-QX6SXRUW.js";
import "./chunk-7ANVLPZR.js";
import "./chunk-5APKM53F.js";
import {
  RouteFocusModal,
  StackedFocusModal,
  useRouteModal,
  useStackedModal
} from "./chunk-YT5VAMIC.js";
import {
  useReturnReasons
} from "./chunk-5ZN7P73X.js";
import "./chunk-IA4ROPJA.js";
import {
  t
} from "./chunk-PCTCLP5F.js";
import {
  z
} from "./chunk-TIDE7BTD.js";
import {
  Thumbnail
} from "./chunk-C5UXJTEP.js";
import "./chunk-Z7F5NKRC.js";
import {
  ActionMenu
} from "./chunk-EYORFNKO.js";
import "./chunk-DG4VJWMJ.js";
import "./chunk-QL4F4XO7.js";
import "./chunk-NV2N3EWM.js";
import "./chunk-7UAYECTW.js";
import "./chunk-QKV675OM.js";
import "./chunk-Y3NYV3NU.js";
import "./chunk-MPXR7HT5.js";
import {
  Form,
  useFieldArray,
  useForm
} from "./chunk-35WWOOGE.js";
import {
  useVariants
} from "./chunk-OMI2M33L.js";
import "./chunk-4QP6TRY2.js";
import "./chunk-WKVXAGJ4.js";
import "./chunk-MTIJOLRN.js";
import "./chunk-W5OVXSM3.js";
import "./chunk-F2QLOFUO.js";
import "./chunk-LHFWZMHR.js";
import "./chunk-SYV5SNLT.js";
import "./chunk-HZTIKFN6.js";
import "./chunk-VVFYDDT7.js";
import "./chunk-OBY5H4ES.js";
import "./chunk-VIDY2VVW.js";
import "./chunk-CQLZVZFY.js";
import "./chunk-KAPOO4V5.js";
import "./chunk-3APLRSSZ.js";
import "./chunk-MT32KGKB.js";
import "./chunk-HYIUH3A4.js";
import {
  useShippingOptions
} from "./chunk-UWY4GNKH.js";
import {
  useStockLocations
} from "./chunk-XZA7URE7.js";
import {
  useOrder,
  useOrderPreview
} from "./chunk-X6CL4M66.js";
import "./chunk-ITDBSFWD.js";
import "./chunk-33KS7DQ7.js";
import "./chunk-4VIDBIP2.js";
import "./chunk-5SYURXII.js";
import "./chunk-QR3D3QJD.js";
import "./chunk-X7XNLRVH.js";
import "./chunk-KIJJ36HY.js";
import "./chunk-VMLNCWLE.js";
import "./chunk-CUPZIPFX.js";
import {
  sdk
} from "./chunk-YEE23PNJ.js";
import {
  useTranslation
} from "./chunk-7HWTQOXJ.js";
import "./chunk-5GF3RGIE.js";
import {
  useNavigate,
  useParams
} from "./chunk-T7YBVUWZ.js";
import {
  Alert,
  Button,
  ChatBubble,
  Checkbox,
  CurrencyInput2 as CurrencyInput,
  DocumentText,
  Heading,
  IconButton,
  Input,
  PencilSquare,
  Switch,
  Text,
  XCircle,
  XMark,
  createColumnHelper,
  toast,
  usePrompt
} from "./chunk-OMPDROWC.js";
import "./chunk-5GLF3XJW.js";
import "./chunk-RPCDYKBN.js";
import "./chunk-VZFGHTQI.js";
import "./chunk-R35JBZ3G.js";
import {
  require_jsx_runtime
} from "./chunk-KBTYAULA.js";
import {
  require_react
} from "./chunk-QCHXOAYK.js";
import {
  __toESM
} from "./chunk-WOOG5QLI.js";

// node_modules/@medusajs/dashboard/dist/order-create-exchange-AEMOZGTG.mjs
var import_react = __toESM(require_react(), 1);
var import_react2 = __toESM(require_react(), 1);
var import_react3 = __toESM(require_react(), 1);
var import_react4 = __toESM(require_react(), 1);
var import_react5 = __toESM(require_react(), 1);
var import_jsx_runtime = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime2 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime3 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime4 = __toESM(require_jsx_runtime(), 1);
var import_react6 = __toESM(require_react(), 1);
var import_react7 = __toESM(require_react(), 1);
var import_react8 = __toESM(require_react(), 1);
var import_jsx_runtime5 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime6 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime7 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime8 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime9 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime10 = __toESM(require_jsx_runtime(), 1);
var ExchangeCreateSchema = z.object({
  inbound_items: z.array(
    z.object({
      item_id: z.string(),
      quantity: z.number(),
      reason_id: z.string().nullish(),
      note: z.string().nullish()
    })
  ),
  outbound_items: z.array(
    z.object({
      item_id: z.string(),
      quantity: z.number()
    })
  ),
  location_id: z.string().optional(),
  inbound_option_id: z.string().nullish(),
  outbound_option_id: z.string().nullish(),
  send_notification: z.boolean().optional()
});
var columnHelper = createColumnHelper();
var useExchangeItemTableColumns = (currencyCode) => {
  const { t: t2 } = useTranslation();
  return (0, import_react5.useMemo)(
    () => [
      columnHelper.display({
        id: "select",
        header: ({ table }) => {
          return (0, import_jsx_runtime.jsx)(
            Checkbox,
            {
              checked: table.getIsSomePageRowsSelected() ? "indeterminate" : table.getIsAllPageRowsSelected(),
              onCheckedChange: (value) => table.toggleAllPageRowsSelected(!!value)
            }
          );
        },
        cell: ({ row }) => {
          const isSelectable = row.getCanSelect();
          return (0, import_jsx_runtime.jsx)(
            Checkbox,
            {
              disabled: !isSelectable,
              checked: row.getIsSelected(),
              onCheckedChange: (value) => row.toggleSelected(!!value),
              onClick: (e) => {
                e.stopPropagation();
              }
            }
          );
        }
      }),
      columnHelper.display({
        id: "product",
        header: () => (0, import_jsx_runtime.jsx)(ProductHeader, {}),
        cell: ({ row }) => (0, import_jsx_runtime.jsx)(
          ProductCell,
          {
            product: {
              thumbnail: row.original.thumbnail,
              title: row.original.product_title
            }
          }
        )
      }),
      columnHelper.accessor("variant.sku", {
        header: t2("fields.sku"),
        cell: ({ getValue }) => {
          return getValue() || "-";
        }
      }),
      columnHelper.accessor("variant.title", {
        header: t2("fields.variant")
      }),
      columnHelper.accessor("quantity", {
        header: () => (0, import_jsx_runtime.jsx)("div", { className: "flex size-full items-center overflow-hidden text-right", children: (0, import_jsx_runtime.jsx)("span", { className: "truncate", children: t2("fields.quantity") }) }),
        cell: ({ getValue, row }) => {
          return getReturnableQuantity(row.original);
        }
      }),
      columnHelper.accessor("refundable_total", {
        header: () => (0, import_jsx_runtime.jsx)("div", { className: "flex size-full items-center justify-end overflow-hidden text-right", children: (0, import_jsx_runtime.jsx)("span", { className: "truncate", children: t2("fields.price") }) }),
        cell: ({ getValue }) => {
          const amount = getValue() || 0;
          const stylized = getStylizedAmount(amount, currencyCode);
          return (0, import_jsx_runtime.jsx)("div", { className: "flex size-full items-center justify-end overflow-hidden text-right", children: (0, import_jsx_runtime.jsx)("span", { className: "truncate", children: stylized }) });
        }
      })
    ],
    [t2, currencyCode]
  );
};
var useExchangeItemTableFilters = () => {
  const { t: t2 } = useTranslation();
  const filters = [
    {
      key: "created_at",
      label: t2("fields.createdAt"),
      type: "date"
    },
    {
      key: "updated_at",
      label: t2("fields.updatedAt"),
      type: "date"
    }
  ];
  return filters;
};
var useExchangeItemTableQuery = ({
  pageSize = 50,
  prefix
}) => {
  const raw = useQueryParams(
    ["q", "offset", "order", "created_at", "updated_at"],
    prefix
  );
  const { offset, created_at, updated_at, ...rest } = raw;
  const searchParams = {
    ...rest,
    limit: pageSize,
    offset: offset ? Number(offset) : 0,
    created_at: created_at ? JSON.parse(created_at) : void 0,
    updated_at: updated_at ? JSON.parse(updated_at) : void 0
  };
  return { searchParams, raw };
};
var PAGE_SIZE = 50;
var PREFIX = "rit";
var AddExchangeInboundItemsTable = ({
  onSelectionChange,
  selectedItems,
  items,
  currencyCode
}) => {
  const { t: t2 } = useTranslation();
  const [rowSelection, setRowSelection] = (0, import_react4.useState)(
    selectedItems.reduce((acc, id) => {
      acc[id] = true;
      return acc;
    }, {})
  );
  const updater = (fn) => {
    const newState = typeof fn === "function" ? fn(rowSelection) : fn;
    setRowSelection(newState);
    onSelectionChange(Object.keys(newState));
  };
  const { searchParams, raw } = useExchangeItemTableQuery({
    pageSize: PAGE_SIZE,
    prefix: PREFIX
  });
  const queriedItems = (0, import_react4.useMemo)(() => {
    const { order, offset, limit, q, created_at, updated_at } = searchParams;
    let results = items;
    if (q) {
      results = results.filter((i) => {
        var _a;
        return i.product_title.toLowerCase().includes(q.toLowerCase()) || i.variant_title.toLowerCase().includes(q.toLowerCase()) || ((_a = i.variant_sku) == null ? void 0 : _a.toLowerCase().includes(q.toLowerCase()));
      });
    }
    if (order) {
      const direction = order[0] === "-" ? "desc" : "asc";
      const field = order.replace("-", "");
      results = sortItems(results, field, direction);
    }
    if (created_at) {
      results = filterByDate(results, created_at, "created_at");
    }
    if (updated_at) {
      results = filterByDate(results, updated_at, "updated_at");
    }
    return results.slice(offset, offset + limit);
  }, [items, currencyCode, searchParams]);
  const columns = useExchangeItemTableColumns(currencyCode);
  const filters = useExchangeItemTableFilters();
  const { table } = useDataTable({
    data: queriedItems,
    columns,
    count: queriedItems.length,
    enablePagination: true,
    getRowId: (row) => row.id,
    pageSize: PAGE_SIZE,
    enableRowSelection: (row) => {
      return getReturnableQuantity(row.original) > 0;
    },
    rowSelection: {
      state: rowSelection,
      updater
    }
  });
  return (0, import_jsx_runtime2.jsx)("div", { className: "flex size-full flex-col overflow-hidden", children: (0, import_jsx_runtime2.jsx)(
    _DataTable,
    {
      table,
      columns,
      pageSize: PAGE_SIZE,
      count: queriedItems.length,
      filters,
      pagination: true,
      layout: "fill",
      search: true,
      orderBy: [
        { key: "product_title", label: t2("fields.product") },
        { key: "variant_title", label: t2("fields.variant") },
        { key: "sku", label: t2("fields.sku") }
      ],
      prefix: PREFIX,
      queryObject: raw
    }
  ) });
};
var sortItems = (items, field, direction) => {
  return items.sort((a, b) => {
    let aValue;
    let bValue;
    if (field === "product_title") {
      aValue = a.product_title;
      bValue = b.product_title;
    } else if (field === "variant_title") {
      aValue = a.variant_title;
      bValue = b.variant_title;
    } else if (field === "sku") {
      aValue = a.variant_sku;
      bValue = b.variant_sku;
    }
    if (aValue < bValue) {
      return direction === "asc" ? -1 : 1;
    }
    if (aValue > bValue) {
      return direction === "asc" ? 1 : -1;
    }
    return 0;
  });
};
var filterByDate = (items, date, field) => {
  const { gt, gte, lt, lte } = date;
  return items.filter((i) => {
    const itemDate = new Date(i[field]);
    let isValid = true;
    if (gt) {
      isValid = isValid && itemDate > new Date(gt);
    }
    if (gte) {
      isValid = isValid && itemDate >= new Date(gte);
    }
    if (lt) {
      isValid = isValid && itemDate < new Date(lt);
    }
    if (lte) {
      isValid = isValid && itemDate <= new Date(lte);
    }
    return isValid;
  });
};
function ExchangeInboundItem({
  item,
  previewItem,
  currencyCode,
  form,
  onRemove,
  onUpdate,
  index
}) {
  const { t: t2 } = useTranslation();
  const { return_reasons = [] } = useReturnReasons({ fields: "+label" });
  const formItem = form.watch(`inbound_items.${index}`);
  const showReturnReason = typeof formItem.reason_id === "string";
  const showNote = typeof formItem.note === "string";
  return (0, import_jsx_runtime3.jsxs)("div", { className: "bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ", children: [
    (0, import_jsx_runtime3.jsxs)("div", { className: "flex flex-col items-center gap-x-2 gap-y-2 p-3 text-sm md:flex-row", children: [
      (0, import_jsx_runtime3.jsxs)("div", { className: "flex flex-1 items-center gap-x-3", children: [
        (0, import_jsx_runtime3.jsx)(Thumbnail, { src: item.thumbnail }),
        (0, import_jsx_runtime3.jsxs)("div", { className: "flex flex-col", children: [
          (0, import_jsx_runtime3.jsxs)("div", { children: [
            (0, import_jsx_runtime3.jsxs)(Text, { className: "txt-small", as: "span", weight: "plus", children: [
              item.title,
              " "
            ] }),
            item.variant_sku && (0, import_jsx_runtime3.jsxs)("span", { children: [
              "(",
              item.variant_sku,
              ")"
            ] })
          ] }),
          (0, import_jsx_runtime3.jsx)(Text, { as: "div", className: "text-ui-fg-subtle txt-small", children: item.product_title })
        ] })
      ] }),
      (0, import_jsx_runtime3.jsxs)("div", { className: "flex flex-1 justify-between", children: [
        (0, import_jsx_runtime3.jsxs)("div", { className: "flex flex-grow items-center gap-2", children: [
          (0, import_jsx_runtime3.jsx)(
            Form.Field,
            {
              control: form.control,
              name: `inbound_items.${index}.quantity`,
              render: ({ field }) => {
                return (0, import_jsx_runtime3.jsxs)(Form.Item, { children: [
                  (0, import_jsx_runtime3.jsx)(Form.Control, { children: (0, import_jsx_runtime3.jsx)(
                    Input,
                    {
                      ...field,
                      className: "bg-ui-bg-base txt-small w-[67px] rounded-lg",
                      min: 1,
                      max: item.quantity,
                      type: "number",
                      onBlur: (e) => {
                        const val = e.target.value;
                        const payload = val === "" ? null : Number(val);
                        field.onChange(payload);
                        if (payload) {
                          onUpdate({ quantity: payload });
                        }
                      }
                    }
                  ) }),
                  (0, import_jsx_runtime3.jsx)(Form.ErrorMessage, {})
                ] });
              }
            }
          ),
          (0, import_jsx_runtime3.jsx)(Text, { className: "txt-small text-ui-fg-subtle", children: t2("fields.qty") })
        ] }),
        (0, import_jsx_runtime3.jsx)("div", { className: "text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0", children: (0, import_jsx_runtime3.jsx)(
          MoneyAmountCell,
          {
            currencyCode,
            amount: previewItem.return_requested_total
          }
        ) }),
        (0, import_jsx_runtime3.jsx)(
          ActionMenu,
          {
            groups: [
              {
                actions: [
                  !showReturnReason && {
                    label: t2("actions.addReason"),
                    onClick: () => form.setValue(`inbound_items.${index}.reason_id`, ""),
                    icon: (0, import_jsx_runtime3.jsx)(ChatBubble, {})
                  },
                  !showNote && {
                    label: t2("actions.addNote"),
                    onClick: () => form.setValue(`inbound_items.${index}.note`, ""),
                    icon: (0, import_jsx_runtime3.jsx)(DocumentText, {})
                  },
                  {
                    label: t2("actions.remove"),
                    onClick: onRemove,
                    icon: (0, import_jsx_runtime3.jsx)(XCircle, {})
                  }
                ].filter(Boolean)
              }
            ]
          }
        )
      ] })
    ] }),
    (0, import_jsx_runtime3.jsxs)(import_jsx_runtime3.Fragment, { children: [
      showReturnReason && (0, import_jsx_runtime3.jsxs)("div", { className: "grid grid-cols-1 gap-2 p-3 md:grid-cols-2", children: [
        (0, import_jsx_runtime3.jsxs)("div", { children: [
          (0, import_jsx_runtime3.jsx)(Form.Label, { children: t2("orders.returns.reason") }),
          (0, import_jsx_runtime3.jsx)(Form.Hint, { className: "!mt-1", children: t2("orders.returns.reasonHint") })
        ] }),
        (0, import_jsx_runtime3.jsxs)("div", { className: "flex items-center gap-1", children: [
          (0, import_jsx_runtime3.jsx)("div", { className: "flex-grow", children: (0, import_jsx_runtime3.jsx)(
            Form.Field,
            {
              control: form.control,
              name: `inbound_items.${index}.reason_id`,
              render: ({ field: { ref, value, onChange, ...field } }) => {
                return (0, import_jsx_runtime3.jsxs)(Form.Item, { children: [
                  (0, import_jsx_runtime3.jsx)(Form.Control, { children: (0, import_jsx_runtime3.jsx)(
                    Combobox,
                    {
                      className: "bg-ui-bg-field-component hover:bg-ui-bg-field-component-hover",
                      value,
                      onChange: (v) => {
                        onUpdate({ reason_id: v });
                        onChange(v);
                      },
                      ...field,
                      options: return_reasons.map((reason) => ({
                        label: reason.label,
                        value: reason.id
                      }))
                    }
                  ) }),
                  (0, import_jsx_runtime3.jsx)(Form.ErrorMessage, {})
                ] });
              }
            }
          ) }),
          (0, import_jsx_runtime3.jsx)(
            IconButton,
            {
              type: "button",
              className: "flex-shrink",
              variant: "transparent",
              onClick: () => {
                form.setValue(`inbound_items.${index}.reason_id`, null);
                onUpdate({ reason_id: null });
              },
              children: (0, import_jsx_runtime3.jsx)(XMark, { className: "text-ui-fg-muted" })
            }
          )
        ] })
      ] }),
      showNote && (0, import_jsx_runtime3.jsxs)("div", { className: "grid grid-cols-1 gap-2 p-3 md:grid-cols-2", children: [
        (0, import_jsx_runtime3.jsxs)("div", { children: [
          (0, import_jsx_runtime3.jsx)(Form.Label, { children: t2("orders.returns.note") }),
          (0, import_jsx_runtime3.jsx)(Form.Hint, { className: "!mt-1", children: t2("orders.returns.noteHint") })
        ] }),
        (0, import_jsx_runtime3.jsxs)("div", { className: "flex items-center gap-1", children: [
          (0, import_jsx_runtime3.jsx)("div", { className: "flex-grow", children: (0, import_jsx_runtime3.jsx)(
            Form.Field,
            {
              control: form.control,
              name: `inbound_items.${index}.note`,
              render: ({ field: { ref, ...field } }) => {
                return (0, import_jsx_runtime3.jsxs)(Form.Item, { children: [
                  (0, import_jsx_runtime3.jsx)(Form.Control, { children: (0, import_jsx_runtime3.jsx)(
                    Input,
                    {
                      ...field,
                      onBlur: () => {
                        field.onChange(field.value);
                        onUpdate({ internal_note: field.value });
                      },
                      className: "bg-ui-bg-field-component hover:bg-ui-bg-field-component-hover"
                    }
                  ) }),
                  (0, import_jsx_runtime3.jsx)(Form.ErrorMessage, {})
                ] });
              }
            }
          ) }),
          (0, import_jsx_runtime3.jsx)(
            IconButton,
            {
              type: "button",
              className: "flex-shrink",
              variant: "transparent",
              onClick: () => {
                form.setValue(`inbound_items.${index}.note`, null);
                onUpdate({ internal_note: null });
              },
              children: (0, import_jsx_runtime3.jsx)(XMark, { className: "text-ui-fg-muted" })
            }
          )
        ] })
      ] })
    ] })
  ] });
}
var itemsToAdd = [];
var itemsToRemove = [];
var ExchangeInboundSection = ({
  order,
  preview,
  exchange,
  form,
  orderReturn
}) => {
  var _a;
  const { t: t2 } = useTranslation();
  const { setIsOpen } = useStackedModal();
  const [inventoryMap, setInventoryMap] = (0, import_react3.useState)({});
  const { mutateAsync: updateReturn } = useUpdateReturn(
    (_a = preview == null ? void 0 : preview.order_change) == null ? void 0 : _a.return_id,
    order.id
  );
  const { mutateAsync: addInboundShipping } = useAddExchangeInboundShipping(
    exchange.id,
    order.id
  );
  const { mutateAsync: deleteInboundShipping } = useDeleteExchangeInboundShipping(exchange.id, order.id);
  const { mutateAsync: addInboundItem } = useAddExchangeInboundItems(
    exchange.id,
    order.id
  );
  const { mutateAsync: updateInboundItem } = useUpdateExchangeInboundItem(
    exchange.id,
    order.id
  );
  const { mutateAsync: removeInboundItem } = useRemoveExchangeInboundItem(
    exchange.id,
    order.id
  );
  const previewInboundItems = (0, import_react3.useMemo)(
    () => {
      var _a2;
      return (_a2 = preview == null ? void 0 : preview.items) == null ? void 0 : _a2.filter(
        (i) => {
          var _a3;
          return !!((_a3 = i.actions) == null ? void 0 : _a3.find((a) => a.exchange_id === exchange.id));
        }
      );
    },
    [preview.items]
  );
  const inboundPreviewItems = previewInboundItems.filter(
    (item) => {
      var _a2;
      return !!((_a2 = item.actions) == null ? void 0 : _a2.find((a) => a.action === "RETURN_ITEM"));
    }
  );
  const itemsMap = (0, import_react3.useMemo)(
    () => {
      var _a2;
      return new Map((_a2 = order == null ? void 0 : order.items) == null ? void 0 : _a2.map((i) => [i.id, i]));
    },
    [order.items]
  );
  const locationId = form.watch("location_id");
  const { stock_locations = [] } = useStockLocations({ limit: 999 });
  const { shipping_options = [] } = useShippingOptions(
    {
      limit: 999,
      fields: "*prices,+service_zone.fulfillment_set.location.id",
      stock_location_id: locationId
    },
    {
      enabled: !!locationId
    }
  );
  const inboundShippingOptions = shipping_options.filter(
    (shippingOption) => !!shippingOption.rules.find(
      (r) => r.attribute === "is_return" && r.value === "true"
    )
  );
  const {
    fields: inboundItems,
    append,
    remove,
    update
  } = useFieldArray({
    name: "inbound_items",
    control: form.control
  });
  const inboundItemsMap = (0, import_react3.useMemo)(
    () => new Map(previewInboundItems.map((i) => [i.id, i])),
    [previewInboundItems, inboundItems]
  );
  (0, import_react3.useEffect)(() => {
    const existingItemsMap = {};
    inboundPreviewItems.forEach((i) => {
      var _a2, _b;
      const ind = inboundItems.findIndex((field) => field.item_id === i.id);
      existingItemsMap[i.id] = true;
      if (ind > -1) {
        if (inboundItems[ind].quantity !== i.detail.return_requested_quantity) {
          const returnItemAction = (_a2 = i.actions) == null ? void 0 : _a2.find(
            (a) => a.action === "RETURN_ITEM"
          );
          update(ind, {
            ...inboundItems[ind],
            quantity: i.detail.return_requested_quantity,
            note: returnItemAction == null ? void 0 : returnItemAction.internal_note,
            reason_id: (_b = returnItemAction == null ? void 0 : returnItemAction.details) == null ? void 0 : _b.reason_id
          });
        }
      } else {
        append(
          { item_id: i.id, quantity: i.detail.return_requested_quantity },
          { shouldFocus: false }
        );
      }
    });
    inboundItems.forEach((i, ind) => {
      if (!(i.item_id in existingItemsMap)) {
        remove(ind);
      }
    });
  }, [previewInboundItems]);
  (0, import_react3.useEffect)(() => {
    const inboundShippingMethod = preview.shipping_methods.find(
      (s) => {
        var _a2;
        return (_a2 = s.actions) == null ? void 0 : _a2.find((a) => a.action === "SHIPPING_ADD" && !!a.return_id);
      }
    );
    if (inboundShippingMethod) {
      form.setValue(
        "inbound_option_id",
        inboundShippingMethod.shipping_option_id
      );
    } else {
      form.setValue("inbound_option_id", "");
    }
  }, [preview.shipping_methods]);
  (0, import_react3.useEffect)(() => {
    form.setValue("location_id", orderReturn == null ? void 0 : orderReturn.location_id);
  }, [orderReturn]);
  const showInboundItemsPlaceholder = !inboundItems.length;
  const onItemsSelected = async () => {
    var _a2, _b, _c;
    itemsToAdd.length && await addInboundItem(
      {
        items: itemsToAdd.map((id) => ({
          id,
          quantity: 1
        }))
      },
      {
        onError: (error) => {
          toast.error(error.message);
        }
      }
    );
    for (const itemToRemove of itemsToRemove) {
      const actionId = (_c = (_b = (_a2 = previewInboundItems.find((i) => i.id === itemToRemove)) == null ? void 0 : _a2.actions) == null ? void 0 : _b.find((a) => a.action === "RETURN_ITEM")) == null ? void 0 : _c.id;
      if (actionId) {
        await removeInboundItem(actionId, {
          onError: (error) => {
            toast.error(error.message);
          }
        });
      }
    }
    setIsOpen("inbound-items", false);
  };
  const onLocationChange = async (selectedLocationId) => {
    await updateReturn({ location_id: selectedLocationId });
  };
  const onShippingOptionChange = async (selectedOptionId) => {
    const inboundShippingMethods = preview.shipping_methods.filter(
      (s) => {
        var _a2;
        return (_a2 = s.actions) == null ? void 0 : _a2.find((a) => a.action === "SHIPPING_ADD" && !!a.return_id);
      }
    );
    const promises = inboundShippingMethods.filter(Boolean).map((inboundShippingMethod) => {
      var _a2;
      const action = (_a2 = inboundShippingMethod.actions) == null ? void 0 : _a2.find(
        (a) => a.action === "SHIPPING_ADD" && !!a.return_id
      );
      if (action) {
        return deleteInboundShipping(action.id);
      }
    });
    await Promise.all(promises);
    if (selectedOptionId) {
      await addInboundShipping(
        { shipping_option_id: selectedOptionId },
        {
          onError: (error) => {
            toast.error(error.message);
          }
        }
      );
    }
  };
  const showLevelsWarning = (0, import_react3.useMemo)(() => {
    if (!locationId) {
      return false;
    }
    const allItemsHaveLocation = inboundItems.map((_i) => {
      var _a2, _b;
      const item = itemsMap.get(_i.item_id);
      if (!(item == null ? void 0 : item.variant_id) || !(item == null ? void 0 : item.variant)) {
        return true;
      }
      if (!((_a2 = item.variant) == null ? void 0 : _a2.manage_inventory)) {
        return true;
      }
      return (_b = inventoryMap[item.variant_id]) == null ? void 0 : _b.find(
        (l) => l.location_id === locationId
      );
    }).every(Boolean);
    return !allItemsHaveLocation;
  }, [inboundItems, inventoryMap, locationId]);
  (0, import_react3.useEffect)(() => {
    const getInventoryMap = async () => {
      const ret = {};
      if (!inboundItems.length) {
        return ret;
      }
      const variantIds = inboundItems.map((item) => item == null ? void 0 : item.variant_id).filter(Boolean);
      const variants = (await sdk.admin.productVariant.list({
        id: variantIds,
        fields: "*inventory.location_levels"
      })).variants;
      variants.forEach((variant) => {
        var _a2, _b;
        ret[variant.id] = ((_b = (_a2 = variant.inventory) == null ? void 0 : _a2[0]) == null ? void 0 : _b.location_levels) || [];
      });
      return ret;
    };
    getInventoryMap().then((map) => {
      setInventoryMap(map);
    });
  }, [inboundItems]);
  return (0, import_jsx_runtime4.jsxs)("div", { children: [
    (0, import_jsx_runtime4.jsxs)("div", { className: "mt-8 flex items-center justify-between", children: [
      (0, import_jsx_runtime4.jsx)(Heading, { level: "h2", children: t2("orders.returns.inbound") }),
      (0, import_jsx_runtime4.jsxs)(StackedFocusModal, { id: "inbound-items", children: [
        (0, import_jsx_runtime4.jsx)(StackedFocusModal.Trigger, { asChild: true, children: (0, import_jsx_runtime4.jsx)("a", { className: "focus-visible:shadow-borders-focus transition-fg txt-compact-small-plus cursor-pointer text-blue-500 outline-none hover:text-blue-400", children: t2("actions.addItems") }) }),
        (0, import_jsx_runtime4.jsxs)(StackedFocusModal.Content, { children: [
          (0, import_jsx_runtime4.jsx)(StackedFocusModal.Header, {}),
          (0, import_jsx_runtime4.jsx)(
            AddExchangeInboundItemsTable,
            {
              items: order.items,
              selectedItems: inboundItems.map((i) => i.item_id),
              currencyCode: order.currency_code,
              onSelectionChange: (finalSelection) => {
                const alreadySelected = inboundItems.map((i) => i.item_id);
                itemsToAdd = finalSelection.filter(
                  (selection) => !alreadySelected.includes(selection)
                );
                itemsToRemove = alreadySelected.filter(
                  (selection) => !finalSelection.includes(selection)
                );
              }
            }
          ),
          (0, import_jsx_runtime4.jsx)(StackedFocusModal.Footer, { children: (0, import_jsx_runtime4.jsx)("div", { className: "flex w-full items-center justify-end gap-x-4", children: (0, import_jsx_runtime4.jsxs)("div", { className: "flex items-center justify-end gap-x-2", children: [
            (0, import_jsx_runtime4.jsx)(RouteFocusModal.Close, { asChild: true, children: (0, import_jsx_runtime4.jsx)(Button, { type: "button", variant: "secondary", size: "small", children: t2("actions.cancel") }) }),
            (0, import_jsx_runtime4.jsx)(
              Button,
              {
                type: "submit",
                variant: "primary",
                size: "small",
                role: "button",
                onClick: async () => await onItemsSelected(),
                children: t2("actions.save")
              },
              "submit-button"
            )
          ] }) }) })
        ] })
      ] })
    ] }),
    showInboundItemsPlaceholder && (0, import_jsx_runtime4.jsx)(ItemPlaceholder, {}),
    inboundItems.map(
      (item, index) => inboundItemsMap.get(item.item_id) && itemsMap.get(item.item_id) && (0, import_jsx_runtime4.jsx)(
        ExchangeInboundItem,
        {
          item: itemsMap.get(item.item_id),
          previewItem: inboundItemsMap.get(item.item_id),
          currencyCode: order.currency_code,
          form,
          onRemove: () => {
            var _a2, _b, _c;
            const actionId = (_c = (_b = (_a2 = previewInboundItems.find((i) => i.id === item.item_id)) == null ? void 0 : _a2.actions) == null ? void 0 : _b.find((a) => a.action === "RETURN_ITEM")) == null ? void 0 : _c.id;
            if (actionId) {
              removeInboundItem(actionId, {
                onError: (error) => {
                  toast.error(error.message);
                }
              });
            }
          },
          onUpdate: (payload) => {
            var _a2, _b;
            const action = (_b = (_a2 = previewInboundItems.find((i) => i.id === item.item_id)) == null ? void 0 : _a2.actions) == null ? void 0 : _b.find((a) => a.action === "RETURN_ITEM");
            if (action) {
              updateInboundItem(
                { ...payload, actionId: action.id },
                {
                  onError: (error) => {
                    var _a3, _b2;
                    if (((_a3 = action.details) == null ? void 0 : _a3.quantity) && payload.quantity) {
                      form.setValue(
                        `inbound_items.${index}.quantity`,
                        (_b2 = action.details) == null ? void 0 : _b2.quantity
                      );
                    }
                    toast.error(error.message);
                  }
                }
              );
            }
          },
          index
        },
        item.id
      )
    ),
    !showInboundItemsPlaceholder && (0, import_jsx_runtime4.jsxs)("div", { className: "mt-8 flex flex-col gap-y-4", children: [
      (0, import_jsx_runtime4.jsxs)("div", { className: "grid grid-cols-1 gap-2 md:grid-cols-2", children: [
        (0, import_jsx_runtime4.jsxs)("div", { children: [
          (0, import_jsx_runtime4.jsx)(Form.Label, { children: t2("orders.returns.location") }),
          (0, import_jsx_runtime4.jsx)(Form.Hint, { className: "!mt-1", children: t2("orders.returns.locationHint") })
        ] }),
        (0, import_jsx_runtime4.jsx)(
          Form.Field,
          {
            control: form.control,
            name: "location_id",
            render: ({ field: { value, onChange, ...field } }) => {
              return (0, import_jsx_runtime4.jsx)(Form.Item, { children: (0, import_jsx_runtime4.jsx)(Form.Control, { children: (0, import_jsx_runtime4.jsx)(
                Combobox,
                {
                  ...field,
                  value: value ?? void 0,
                  onChange: (v) => {
                    onChange(v);
                    onLocationChange(v);
                  },
                  options: (stock_locations ?? []).map(
                    (stockLocation) => ({
                      label: stockLocation.name,
                      value: stockLocation.id
                    })
                  )
                }
              ) }) });
            }
          }
        )
      ] }),
      (0, import_jsx_runtime4.jsxs)("div", { className: "grid grid-cols-1 gap-2 md:grid-cols-2", children: [
        (0, import_jsx_runtime4.jsxs)("div", { children: [
          (0, import_jsx_runtime4.jsxs)(Form.Label, { children: [
            t2("orders.returns.inboundShipping"),
            (0, import_jsx_runtime4.jsxs)(
              Text,
              {
                size: "small",
                leading: "compact",
                className: "text-ui-fg-muted ml-1 inline",
                children: [
                  "(",
                  t2("fields.optional"),
                  ")"
                ]
              }
            )
          ] }),
          (0, import_jsx_runtime4.jsx)(Form.Hint, { className: "!mt-1", children: t2("orders.returns.inboundShippingHint") })
        ] }),
        (0, import_jsx_runtime4.jsx)(
          Form.Field,
          {
            control: form.control,
            name: "inbound_option_id",
            render: ({ field: { value, onChange, ...field } }) => {
              return (0, import_jsx_runtime4.jsx)(Form.Item, { children: (0, import_jsx_runtime4.jsx)(Form.Control, { children: (0, import_jsx_runtime4.jsx)(
                Combobox,
                {
                  allowClear: true,
                  value: value ?? void 0,
                  onChange: (val) => {
                    onChange(val);
                    onShippingOptionChange(val);
                  },
                  ...field,
                  options: inboundShippingOptions.map((so) => ({
                    label: so.name,
                    value: so.id
                  })),
                  disabled: !locationId,
                  noResultsPlaceholder: (0, import_jsx_runtime4.jsx)(ReturnShippingPlaceholder, {})
                }
              ) }) });
            }
          }
        )
      ] })
    ] }),
    showLevelsWarning && (0, import_jsx_runtime4.jsxs)(Alert, { variant: "warning", dismissible: true, className: "mt-4 p-5", children: [
      (0, import_jsx_runtime4.jsx)("div", { className: "text-ui-fg-subtle txt-small pb-2 font-medium leading-[20px]", children: t2("orders.returns.noInventoryLevel") }),
      (0, import_jsx_runtime4.jsx)(Text, { className: "text-ui-fg-subtle txt-small leading-normal", children: t2("orders.returns.noInventoryLevelDesc") })
    ] })
  ] });
};
var columnHelper2 = createColumnHelper();
var useExchangeOutboundItemTableColumns = (currencyCode) => {
  const { t: t2 } = useTranslation();
  return (0, import_react8.useMemo)(
    () => [
      columnHelper2.display({
        id: "select",
        header: ({ table }) => {
          return (0, import_jsx_runtime5.jsx)(
            Checkbox,
            {
              checked: table.getIsSomePageRowsSelected() ? "indeterminate" : table.getIsAllPageRowsSelected(),
              onCheckedChange: (value) => table.toggleAllPageRowsSelected(!!value)
            }
          );
        },
        cell: ({ row }) => {
          const isSelectable = row.getCanSelect();
          return (0, import_jsx_runtime5.jsx)(
            Checkbox,
            {
              disabled: !isSelectable,
              checked: row.getIsSelected(),
              onCheckedChange: (value) => row.toggleSelected(!!value),
              onClick: (e) => {
                e.stopPropagation();
              }
            }
          );
        }
      }),
      columnHelper2.display({
        id: "product",
        header: () => (0, import_jsx_runtime5.jsx)(ProductHeader, {}),
        cell: ({ row }) => {
          return (0, import_jsx_runtime5.jsx)(ProductCell, { product: row.original.product });
        }
      }),
      columnHelper2.accessor("sku", {
        header: t2("fields.sku"),
        cell: ({ getValue }) => {
          return getValue() || "-";
        }
      }),
      columnHelper2.accessor("title", {
        header: t2("fields.title")
      })
    ],
    [t2, currencyCode]
  );
};
var useExchangeOutboundItemTableFilters = () => {
  const { t: t2 } = useTranslation();
  const filters = [
    {
      key: "created_at",
      label: t2("fields.createdAt"),
      type: "date"
    },
    {
      key: "updated_at",
      label: t2("fields.updatedAt"),
      type: "date"
    }
  ];
  return filters;
};
var useExchangeOutboundItemTableQuery = ({
  pageSize = 50,
  prefix
}) => {
  const raw = useQueryParams(
    ["q", "offset", "order", "created_at", "updated_at"],
    prefix
  );
  const { offset, created_at, updated_at, ...rest } = raw;
  const searchParams = {
    ...rest,
    limit: pageSize,
    offset: offset ? Number(offset) : 0,
    created_at: created_at ? JSON.parse(created_at) : void 0,
    updated_at: updated_at ? JSON.parse(updated_at) : void 0
  };
  return { searchParams, raw };
};
var PAGE_SIZE2 = 50;
var PREFIX2 = "rit";
var AddExchangeOutboundItemsTable = ({
  onSelectionChange,
  selectedItems,
  currencyCode
}) => {
  const { t: t2 } = useTranslation();
  const [rowSelection, setRowSelection] = (0, import_react7.useState)(
    selectedItems.reduce((acc, id) => {
      acc[id] = true;
      return acc;
    }, {})
  );
  const updater = (fn) => {
    const newState = typeof fn === "function" ? fn(rowSelection) : fn;
    setRowSelection(newState);
    onSelectionChange(Object.keys(newState));
  };
  const { searchParams, raw } = useExchangeOutboundItemTableQuery({
    pageSize: PAGE_SIZE2,
    prefix: PREFIX2
  });
  const { variants = [], count } = useVariants({
    ...searchParams,
    fields: "*inventory_items.inventory.location_levels,+inventory_quantity"
  });
  const columns = useExchangeOutboundItemTableColumns(currencyCode);
  const filters = useExchangeOutboundItemTableFilters();
  const { table } = useDataTable({
    data: variants,
    columns,
    count,
    enablePagination: true,
    getRowId: (row) => row.id,
    pageSize: PAGE_SIZE2,
    enableRowSelection: (_row) => {
      return true;
    },
    rowSelection: {
      state: rowSelection,
      updater
    }
  });
  return (0, import_jsx_runtime6.jsx)("div", { className: "flex size-full flex-col overflow-hidden", children: (0, import_jsx_runtime6.jsx)(
    _DataTable,
    {
      table,
      columns,
      pageSize: PAGE_SIZE2,
      count,
      filters,
      pagination: true,
      layout: "fill",
      search: true,
      orderBy: [
        { key: "product_id", label: t2("fields.product") },
        { key: "title", label: t2("fields.title") },
        { key: "sku", label: t2("fields.sku") }
      ],
      prefix: PREFIX2,
      queryObject: raw
    }
  ) });
};
function ExchangeOutboundItem({
  previewItem,
  currencyCode,
  form,
  onRemove,
  onUpdate,
  index
}) {
  const { t: t2 } = useTranslation();
  return (0, import_jsx_runtime7.jsx)("div", { className: "bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ", children: (0, import_jsx_runtime7.jsxs)("div", { className: "flex flex-col items-center gap-x-2 gap-y-2 p-3 text-sm md:flex-row", children: [
    (0, import_jsx_runtime7.jsxs)("div", { className: "flex flex-1 items-center gap-x-3", children: [
      (0, import_jsx_runtime7.jsx)(Thumbnail, { src: previewItem.thumbnail }),
      (0, import_jsx_runtime7.jsxs)("div", { className: "flex flex-col", children: [
        (0, import_jsx_runtime7.jsxs)("div", { children: [
          (0, import_jsx_runtime7.jsxs)(Text, { className: "txt-small", as: "span", weight: "plus", children: [
            previewItem.title,
            " "
          ] }),
          previewItem.variant_sku && (0, import_jsx_runtime7.jsxs)("span", { children: [
            "(",
            previewItem.variant_sku,
            ")"
          ] })
        ] }),
        (0, import_jsx_runtime7.jsx)(Text, { as: "div", className: "text-ui-fg-subtle txt-small", children: previewItem.subtitle })
      ] })
    ] }),
    (0, import_jsx_runtime7.jsxs)("div", { className: "flex flex-1 justify-between", children: [
      (0, import_jsx_runtime7.jsxs)("div", { className: "flex flex-grow items-center gap-2", children: [
        (0, import_jsx_runtime7.jsx)(
          Form.Field,
          {
            control: form.control,
            name: `outbound_items.${index}.quantity`,
            render: ({ field }) => {
              return (0, import_jsx_runtime7.jsxs)(Form.Item, { children: [
                (0, import_jsx_runtime7.jsx)(Form.Control, { children: (0, import_jsx_runtime7.jsx)(
                  Input,
                  {
                    ...field,
                    className: "bg-ui-bg-base txt-small w-[67px] rounded-lg",
                    min: 1,
                    type: "number",
                    onBlur: (e) => {
                      const val = e.target.value;
                      const payload = val === "" ? null : Number(val);
                      field.onChange(payload);
                      if (payload) {
                        onUpdate({ quantity: payload });
                      }
                    }
                  }
                ) }),
                (0, import_jsx_runtime7.jsx)(Form.ErrorMessage, {})
              ] });
            }
          }
        ),
        (0, import_jsx_runtime7.jsx)(Text, { className: "txt-small text-ui-fg-subtle", children: t2("fields.qty") })
      ] }),
      (0, import_jsx_runtime7.jsx)("div", { className: "text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0", children: (0, import_jsx_runtime7.jsx)(
        MoneyAmountCell,
        {
          currencyCode,
          amount: previewItem.total
        }
      ) }),
      (0, import_jsx_runtime7.jsx)(
        ActionMenu,
        {
          groups: [
            {
              actions: [
                {
                  label: t2("actions.remove"),
                  onClick: onRemove,
                  icon: (0, import_jsx_runtime7.jsx)(XCircle, {})
                }
              ].filter(Boolean)
            }
          ]
        }
      )
    ] })
  ] }) });
}
var itemsToAdd2 = [];
var itemsToRemove2 = [];
var ExchangeOutboundSection = ({
  order,
  preview,
  exchange,
  form
}) => {
  const { t: t2 } = useTranslation();
  const { setIsOpen } = useStackedModal();
  const [inventoryMap, setInventoryMap] = (0, import_react6.useState)({});
  const { shipping_options = [] } = useShippingOptions({
    limit: 999,
    fields: "*prices,+service_zone.fulfillment_set.location.id"
  });
  const outboundShippingOptions = shipping_options.filter(
    (shippingOption) => !!shippingOption.rules.find(
      (r) => r.attribute === "is_return" && r.value === "false"
    )
  );
  const { mutateAsync: addOutboundShipping } = useAddExchangeOutboundShipping(
    exchange.id,
    order.id
  );
  const { mutateAsync: deleteOutboundShipping } = useDeleteExchangeOutboundShipping(exchange.id, order.id);
  const { mutateAsync: addOutboundItem } = useAddExchangeOutboundItems(
    exchange.id,
    order.id
  );
  const { mutateAsync: updateOutboundItem } = useUpdateExchangeOutboundItems(
    exchange.id,
    order.id
  );
  const { mutateAsync: removeOutboundItem } = useRemoveExchangeOutboundItem(
    exchange.id,
    order.id
  );
  const previewOutboundItems = (0, import_react6.useMemo)(
    () => {
      var _a;
      return (_a = preview == null ? void 0 : preview.items) == null ? void 0 : _a.filter(
        (i) => {
          var _a2;
          return !!((_a2 = i.actions) == null ? void 0 : _a2.find(
            (a) => a.exchange_id === exchange.id && a.action === "ITEM_ADD"
          ));
        }
      );
    },
    [preview.items]
  );
  const variantItemMap = (0, import_react6.useMemo)(
    () => {
      var _a;
      return new Map((_a = order == null ? void 0 : order.items) == null ? void 0 : _a.map((i) => [i.variant_id, i]));
    },
    [order.items]
  );
  const {
    fields: outboundItems,
    append,
    remove,
    update
  } = useFieldArray({
    name: "outbound_items",
    control: form.control
  });
  const variantOutboundMap = (0, import_react6.useMemo)(
    () => new Map(previewOutboundItems.map((i) => [i.variant_id, i])),
    [previewOutboundItems, outboundItems]
  );
  (0, import_react6.useEffect)(() => {
    const existingItemsMap = {};
    previewOutboundItems.forEach((i) => {
      const ind = outboundItems.findIndex((field) => field.item_id === i.id);
      existingItemsMap[i.id] = true;
      if (ind > -1) {
        if (outboundItems[ind].quantity !== i.detail.quantity) {
          update(ind, {
            ...outboundItems[ind],
            quantity: i.detail.quantity
          });
        }
      } else {
        append(
          {
            item_id: i.id,
            quantity: i.detail.quantity,
            variant_id: i.variant_id
          },
          { shouldFocus: false }
        );
      }
    });
    outboundItems.forEach((i, ind) => {
      if (!(i.item_id in existingItemsMap)) {
        remove(ind);
      }
    });
  }, [previewOutboundItems]);
  const locationId = form.watch("location_id");
  const showOutboundItemsPlaceholder = !outboundItems.length;
  const onItemsSelected = async () => {
    var _a, _b;
    itemsToAdd2.length && await addOutboundItem(
      {
        items: itemsToAdd2.map((variantId) => ({
          variant_id: variantId,
          quantity: 1
        }))
      },
      {
        onError: (error) => {
          toast.error(error.message);
        }
      }
    );
    for (const itemToRemove of itemsToRemove2) {
      const action = (_b = (_a = previewOutboundItems.find((i) => i.variant_id === itemToRemove)) == null ? void 0 : _a.actions) == null ? void 0 : _b.find((a) => a.action === "ITEM_ADD");
      if (action == null ? void 0 : action.id) {
        await removeOutboundItem(action == null ? void 0 : action.id, {
          onError: (error) => {
            toast.error(error.message);
          }
        });
      }
    }
    setIsOpen("outbound-items", false);
  };
  (0, import_react6.useEffect)(() => {
    const outboundShipping = preview.shipping_methods.find(
      (s) => {
        var _a;
        return !!((_a = s.actions) == null ? void 0 : _a.find((a) => a.action === "SHIPPING_ADD" && !a.return_id));
      }
    );
    if (outboundShipping) {
      form.setValue("outbound_option_id", outboundShipping.shipping_option_id);
    } else {
      form.setValue("outbound_option_id", "");
    }
  }, [preview.shipping_methods]);
  const onShippingOptionChange = async (selectedOptionId) => {
    const outboundShippingMethods = preview.shipping_methods.filter(
      (s) => {
        var _a;
        return !!((_a = s.actions) == null ? void 0 : _a.find((a) => a.action === "SHIPPING_ADD" && !a.return_id));
      }
    );
    const promises = outboundShippingMethods.filter(Boolean).map((outboundShippingMethod) => {
      var _a;
      const action = (_a = outboundShippingMethod.actions) == null ? void 0 : _a.find(
        (a) => a.action === "SHIPPING_ADD" && !a.return_id
      );
      if (action) {
        return deleteOutboundShipping(action.id);
      }
    });
    await Promise.all(promises);
    if (selectedOptionId) {
      await addOutboundShipping(
        { shipping_option_id: selectedOptionId },
        {
          onError: (error) => {
            toast.error(error.message);
          }
        }
      );
    }
  };
  const showLevelsWarning = (0, import_react6.useMemo)(() => {
    if (!locationId) {
      return false;
    }
    const allItemsHaveLocation = outboundItems.map((i) => {
      var _a, _b;
      const item = variantItemMap.get(i.variant_id);
      if (!(item == null ? void 0 : item.variant_id) || !(item == null ? void 0 : item.variant)) {
        return true;
      }
      if (!((_a = item.variant) == null ? void 0 : _a.manage_inventory)) {
        return true;
      }
      return (_b = inventoryMap[item.variant_id]) == null ? void 0 : _b.find(
        (l) => l.location_id === locationId
      );
    }).every(Boolean);
    return !allItemsHaveLocation;
  }, [outboundItems, inventoryMap, locationId]);
  (0, import_react6.useEffect)(() => {
    const getInventoryMap = async () => {
      const ret = {};
      if (!outboundItems.length) {
        return ret;
      }
      const variantIds = outboundItems.map((item) => item == null ? void 0 : item.variant_id).filter(Boolean);
      const variants = (await sdk.admin.productVariant.list({
        id: variantIds,
        fields: "*inventory.location_levels"
      })).variants;
      variants.forEach((variant) => {
        var _a, _b;
        ret[variant.id] = ((_b = (_a = variant.inventory) == null ? void 0 : _a[0]) == null ? void 0 : _b.location_levels) || [];
      });
      return ret;
    };
    getInventoryMap().then((map) => {
      setInventoryMap(map);
    });
  }, [outboundItems]);
  return (0, import_jsx_runtime8.jsxs)("div", { children: [
    (0, import_jsx_runtime8.jsxs)("div", { className: "mt-8 flex items-center justify-between", children: [
      (0, import_jsx_runtime8.jsx)(Heading, { level: "h2", children: t2("orders.returns.outbound") }),
      (0, import_jsx_runtime8.jsxs)(StackedFocusModal, { id: "outbound-items", children: [
        (0, import_jsx_runtime8.jsx)(StackedFocusModal.Trigger, { asChild: true, children: (0, import_jsx_runtime8.jsx)("a", { className: "focus-visible:shadow-borders-focus transition-fg txt-compact-small-plus cursor-pointer text-blue-500 outline-none hover:text-blue-400", children: t2("actions.addItems") }) }),
        (0, import_jsx_runtime8.jsxs)(StackedFocusModal.Content, { children: [
          (0, import_jsx_runtime8.jsx)(StackedFocusModal.Header, {}),
          (0, import_jsx_runtime8.jsx)(
            AddExchangeOutboundItemsTable,
            {
              selectedItems: outboundItems.map((i) => i.variant_id),
              currencyCode: order.currency_code,
              onSelectionChange: (finalSelection) => {
                const alreadySelected = outboundItems.map((i) => i.variant_id);
                itemsToAdd2 = finalSelection.filter(
                  (selection) => !alreadySelected.includes(selection)
                );
                itemsToRemove2 = alreadySelected.filter(
                  (selection) => !finalSelection.includes(selection)
                );
              }
            }
          ),
          (0, import_jsx_runtime8.jsx)(StackedFocusModal.Footer, { children: (0, import_jsx_runtime8.jsx)("div", { className: "flex w-full items-center justify-end gap-x-4", children: (0, import_jsx_runtime8.jsxs)("div", { className: "flex items-center justify-end gap-x-2", children: [
            (0, import_jsx_runtime8.jsx)(RouteFocusModal.Close, { asChild: true, children: (0, import_jsx_runtime8.jsx)(Button, { type: "button", variant: "secondary", size: "small", children: t2("actions.cancel") }) }),
            (0, import_jsx_runtime8.jsx)(
              Button,
              {
                type: "submit",
                variant: "primary",
                size: "small",
                role: "button",
                onClick: async () => await onItemsSelected(),
                children: t2("actions.save")
              },
              "submit-button"
            )
          ] }) }) })
        ] })
      ] })
    ] }),
    showOutboundItemsPlaceholder && (0, import_jsx_runtime8.jsx)(ItemPlaceholder, {}),
    outboundItems.map(
      (item, index) => variantOutboundMap.get(item.variant_id) && (0, import_jsx_runtime8.jsx)(
        ExchangeOutboundItem,
        {
          previewItem: variantOutboundMap.get(item.variant_id),
          currencyCode: order.currency_code,
          form,
          onRemove: () => {
            var _a, _b, _c;
            const actionId = (_c = (_b = (_a = previewOutboundItems.find((i) => i.id === item.item_id)) == null ? void 0 : _a.actions) == null ? void 0 : _b.find((a) => a.action === "ITEM_ADD")) == null ? void 0 : _c.id;
            if (actionId) {
              removeOutboundItem(actionId, {
                onError: (error) => {
                  toast.error(error.message);
                }
              });
            }
          },
          onUpdate: (payload) => {
            var _a, _b, _c;
            const actionId = (_c = (_b = (_a = previewOutboundItems.find((i) => i.id === item.item_id)) == null ? void 0 : _a.actions) == null ? void 0 : _b.find((a) => a.action === "ITEM_ADD")) == null ? void 0 : _c.id;
            if (actionId) {
              updateOutboundItem(
                { ...payload, actionId },
                {
                  onError: (error) => {
                    toast.error(error.message);
                  }
                }
              );
            }
          },
          index
        },
        item.id
      )
    ),
    !showOutboundItemsPlaceholder && (0, import_jsx_runtime8.jsx)("div", { className: "mt-8 flex flex-col gap-y-4", children: (0, import_jsx_runtime8.jsxs)("div", { className: "grid grid-cols-1 gap-2 md:grid-cols-2", children: [
      (0, import_jsx_runtime8.jsxs)("div", { children: [
        (0, import_jsx_runtime8.jsx)(Form.Label, { children: t2("orders.exchanges.outboundShipping") }),
        (0, import_jsx_runtime8.jsx)(Form.Hint, { className: "!mt-1", children: t2("orders.exchanges.outboundShippingHint") })
      ] }),
      (0, import_jsx_runtime8.jsx)(
        Form.Field,
        {
          control: form.control,
          name: "outbound_option_id",
          render: ({ field: { value, onChange, ...field } }) => {
            return (0, import_jsx_runtime8.jsx)(Form.Item, { children: (0, import_jsx_runtime8.jsx)(Form.Control, { children: (0, import_jsx_runtime8.jsx)(
              Combobox,
              {
                allowClear: true,
                noResultsPlaceholder: (0, import_jsx_runtime8.jsx)(OutboundShippingPlaceholder, {}),
                value: value ?? void 0,
                onChange: (val) => {
                  onChange(val);
                  onShippingOptionChange(val);
                },
                ...field,
                options: outboundShippingOptions.map((so) => ({
                  label: so.name,
                  value: so.id
                })),
                disabled: !outboundShippingOptions.length
              }
            ) }) });
          }
        }
      )
    ] }) }),
    showLevelsWarning && (0, import_jsx_runtime8.jsxs)(Alert, { variant: "warning", dismissible: true, className: "mt-4 p-5", children: [
      (0, import_jsx_runtime8.jsx)("div", { className: "text-ui-fg-subtle txt-small pb-2 font-medium leading-[20px]", children: t2("orders.returns.noInventoryLevel") }),
      (0, import_jsx_runtime8.jsx)(Text, { className: "text-ui-fg-subtle txt-small leading-normal", children: t2("orders.returns.noInventoryLevelDesc") })
    ] })
  ] });
};
var IS_CANCELING = false;
var ExchangeCreateForm = ({
  order,
  preview,
  exchange,
  orderReturn
}) => {
  const { t: t2 } = useTranslation();
  const { handleSuccess } = useRouteModal();
  const [isInboundShippingPriceEdit, setIsInboundShippingPriceEdit] = (0, import_react2.useState)(false);
  const [isOutboundShippingPriceEdit, setIsOutboundShippingPriceEdit] = (0, import_react2.useState)(false);
  const [customInboundShippingAmount, setCustomInboundShippingAmount] = (0, import_react2.useState)({
    value: "0",
    float: 0
  });
  const [customOutboundShippingAmount, setCustomOutboundShippingAmount] = (0, import_react2.useState)({
    value: "0",
    float: 0
  });
  const { mutateAsync: confirmExchangeRequest, isPending: isConfirming } = useExchangeConfirmRequest(exchange.id, order.id);
  const { mutateAsync: cancelExchangeRequest, isPending: isCanceling } = useCancelExchangeRequest(exchange.id, order.id);
  const {
    mutateAsync: updateInboundShipping,
    isPending: isUpdatingOutboundShipping
  } = useUpdateExchangeInboundShipping(exchange.id, order.id);
  const {
    mutateAsync: updateOutboundShipping,
    isPending: isUpdatingInboundShipping
  } = useUpdateExchangeOutboundShipping(exchange.id, order.id);
  const isRequestLoading = isConfirming || isCanceling || isUpdatingInboundShipping || isUpdatingOutboundShipping;
  const previewItems = (0, import_react2.useMemo)(
    () => {
      var _a;
      return (_a = preview == null ? void 0 : preview.items) == null ? void 0 : _a.filter(
        (i) => {
          var _a2;
          return !!((_a2 = i.actions) == null ? void 0 : _a2.find((a) => a.exchange_id === exchange.id));
        }
      );
    },
    [preview.items]
  );
  const inboundPreviewItems = previewItems.filter(
    (item) => {
      var _a;
      return !!((_a = item.actions) == null ? void 0 : _a.find((a) => a.action === "RETURN_ITEM"));
    }
  );
  const outboundPreviewItems = previewItems.filter(
    (item) => {
      var _a;
      return !!((_a = item.actions) == null ? void 0 : _a.find((a) => a.action === "ITEM_ADD"));
    }
  );
  const form = useForm({
    defaultValues: () => {
      const inboundShippingMethod = preview.shipping_methods.find((s) => {
        var _a;
        return !!((_a = s.actions) == null ? void 0 : _a.find(
          (a) => a.action === "SHIPPING_ADD" && !!a.return_id
        ));
      });
      const outboundShippingMethod = preview.shipping_methods.find((s) => {
        var _a;
        return !!((_a = s.actions) == null ? void 0 : _a.find(
          (a) => a.action === "SHIPPING_ADD" && !a.return_id
        ));
      });
      return Promise.resolve({
        inbound_items: inboundPreviewItems.map((i) => {
          var _a, _b;
          const inboundAction = (_a = i.actions) == null ? void 0 : _a.find(
            (a) => a.action === "RETURN_ITEM"
          );
          return {
            item_id: i.id,
            variant_id: i.variant_id,
            quantity: i.detail.return_requested_quantity,
            note: inboundAction == null ? void 0 : inboundAction.internal_note,
            reason_id: (_b = inboundAction == null ? void 0 : inboundAction.details) == null ? void 0 : _b.reason_id
          };
        }),
        outbound_items: outboundPreviewItems.map((i) => ({
          item_id: i.id,
          variant_id: i.variant_id,
          quantity: i.detail.quantity
        })),
        inbound_option_id: inboundShippingMethod ? inboundShippingMethod.shipping_option_id : "",
        outbound_option_id: outboundShippingMethod ? outboundShippingMethod.shipping_option_id : "",
        location_id: orderReturn == null ? void 0 : orderReturn.location_id,
        send_notification: false
      });
    },
    resolver: t(ExchangeCreateSchema)
  });
  const inboundShipping = preview.shipping_methods.find((s) => {
    var _a;
    return !!((_a = s.actions) == null ? void 0 : _a.find(
      (a) => a.action === "SHIPPING_ADD" && !!a.return_id
    ));
  });
  const outboundShipping = preview.shipping_methods.find((s) => {
    var _a;
    return !!((_a = s.actions) == null ? void 0 : _a.find((a) => a.action === "SHIPPING_ADD" && !a.return_id));
  });
  (0, import_react2.useEffect)(() => {
    if (inboundShipping) {
      setCustomInboundShippingAmount(inboundShipping.total);
    }
  }, [inboundShipping]);
  (0, import_react2.useEffect)(() => {
    if (outboundShipping) {
      setCustomOutboundShippingAmount(outboundShipping.total);
    }
  }, [outboundShipping]);
  const inboundShippingOptionId = form.watch("inbound_option_id");
  const outboundShippingOptionId = form.watch("outbound_option_id");
  const prompt = usePrompt();
  const handleSubmit = form.handleSubmit(async (data) => {
    try {
      const res = await prompt({
        title: t2("general.areYouSure"),
        description: t2("orders.exchanges.confirmText"),
        confirmText: t2("actions.continue"),
        cancelText: t2("actions.cancel"),
        variant: "confirmation"
      });
      if (!res) {
        return;
      }
      await confirmExchangeRequest({ no_notification: !data.send_notification });
      handleSuccess();
    } catch (e) {
      toast.error(t2("general.error"), {
        description: e.message
      });
    }
  });
  (0, import_react2.useEffect)(() => {
    var _a;
    if (isInboundShippingPriceEdit) {
      (_a = document.getElementById("js-inbound-shipping-input")) == null ? void 0 : _a.focus();
    }
  }, [isInboundShippingPriceEdit]);
  (0, import_react2.useEffect)(() => {
    var _a;
    if (isOutboundShippingPriceEdit) {
      (_a = document.getElementById("js-outbound-shipping-input")) == null ? void 0 : _a.focus();
    }
  }, [isOutboundShippingPriceEdit]);
  (0, import_react2.useEffect)(() => {
    return () => {
      if (IS_CANCELING) {
        cancelExchangeRequest(void 0, {
          onSuccess: () => {
            toast.success(
              t2("orders.exchanges.actions.cancelExchange.successToast")
            );
          },
          onError: (error) => {
            toast.error(error.message);
          }
        });
        IS_CANCELING = false;
      }
    };
  }, []);
  const inboundShippingTotal = (0, import_react2.useMemo)(() => {
    const method = preview.shipping_methods.find(
      (sm) => {
        var _a;
        return !!((_a = sm.actions) == null ? void 0 : _a.find((a) => a.action === "SHIPPING_ADD" && !!a.return_id));
      }
    );
    return (method == null ? void 0 : method.total) || 0;
  }, [preview.shipping_methods]);
  const outboundShippingTotal = (0, import_react2.useMemo)(() => {
    const method = preview.shipping_methods.find(
      (sm) => {
        var _a;
        return !!((_a = sm.actions) == null ? void 0 : _a.find((a) => a.action === "SHIPPING_ADD" && !a.return_id));
      }
    );
    return (method == null ? void 0 : method.total) || 0;
  }, [preview.shipping_methods]);
  return (0, import_jsx_runtime9.jsx)(RouteFocusModal.Form, { form, children: (0, import_jsx_runtime9.jsxs)(KeyboundForm, { onSubmit: handleSubmit, className: "flex h-full flex-col", children: [
    (0, import_jsx_runtime9.jsx)(RouteFocusModal.Header, {}),
    (0, import_jsx_runtime9.jsx)(RouteFocusModal.Body, { className: "flex size-full justify-center overflow-y-auto", children: (0, import_jsx_runtime9.jsxs)("div", { className: "mt-16 w-[720px] max-w-[100%] px-4 md:p-0", children: [
      (0, import_jsx_runtime9.jsx)(Heading, { level: "h1", children: t2("orders.exchanges.create") }),
      (0, import_jsx_runtime9.jsx)(
        ExchangeInboundSection,
        {
          form,
          preview,
          order,
          exchange,
          orderReturn
        }
      ),
      (0, import_jsx_runtime9.jsx)(
        ExchangeOutboundSection,
        {
          form,
          preview,
          order,
          exchange
        }
      ),
      (0, import_jsx_runtime9.jsxs)("div", { className: "mt-8 border-y border-dotted py-4", children: [
        (0, import_jsx_runtime9.jsxs)("div", { className: "mb-2 flex items-center justify-between", children: [
          (0, import_jsx_runtime9.jsx)("span", { className: "txt-small text-ui-fg-subtle", children: t2("orders.returns.inboundTotal") }),
          (0, import_jsx_runtime9.jsx)("span", { className: "txt-small text-ui-fg-subtle", children: getStylizedAmount(
            inboundPreviewItems.reduce((acc, item) => {
              var _a;
              const action = (_a = item.actions) == null ? void 0 : _a.find(
                (act) => act.action === "RETURN_ITEM"
              );
              acc = acc + ((action == null ? void 0 : action.amount) || 0);
              return acc;
            }, 0) * -1,
            order.currency_code
          ) })
        ] }),
        (0, import_jsx_runtime9.jsxs)("div", { className: "mb-2 flex items-center justify-between", children: [
          (0, import_jsx_runtime9.jsx)("span", { className: "txt-small text-ui-fg-subtle", children: t2("orders.exchanges.outboundTotal") }),
          (0, import_jsx_runtime9.jsx)("span", { className: "txt-small text-ui-fg-subtle", children: getStylizedAmount(
            outboundPreviewItems.reduce((acc, item) => {
              var _a;
              const action = (_a = item.actions) == null ? void 0 : _a.find(
                (act) => act.action === "ITEM_ADD"
              );
              acc = acc + ((action == null ? void 0 : action.amount) || 0);
              return acc;
            }, 0),
            order.currency_code
          ) })
        ] }),
        (0, import_jsx_runtime9.jsxs)("div", { className: "mb-2 flex items-center justify-between", children: [
          (0, import_jsx_runtime9.jsx)("span", { className: "txt-small text-ui-fg-subtle", children: t2("orders.returns.inboundShipping") }),
          (0, import_jsx_runtime9.jsxs)("span", { className: "txt-small text-ui-fg-subtle flex items-center", children: [
            !isInboundShippingPriceEdit && (0, import_jsx_runtime9.jsx)(
              IconButton,
              {
                onClick: () => setIsInboundShippingPriceEdit(true),
                variant: "transparent",
                className: "text-ui-fg-muted",
                disabled: !(inboundPreviewItems == null ? void 0 : inboundPreviewItems.length) || !inboundShippingOptionId,
                children: (0, import_jsx_runtime9.jsx)(PencilSquare, {})
              }
            ),
            isInboundShippingPriceEdit ? (0, import_jsx_runtime9.jsx)(
              CurrencyInput,
              {
                id: "js-inbound-shipping-input",
                onBlur: () => {
                  let actionId;
                  preview.shipping_methods.forEach((s) => {
                    if (s.actions) {
                      for (const a of s.actions) {
                        if (a.action === "SHIPPING_ADD" && !!a.return_id) {
                          actionId = a.id;
                        }
                      }
                    }
                  });
                  const customPrice = customInboundShippingAmount.float;
                  if (actionId) {
                    updateInboundShipping(
                      {
                        actionId,
                        custom_amount: customPrice
                      },
                      {
                        onError: (error) => {
                          toast.error(error.message);
                        }
                      }
                    );
                  }
                  setIsInboundShippingPriceEdit(false);
                },
                symbol: currencies[order.currency_code.toUpperCase()].symbol_native,
                code: order.currency_code,
                onValueChange: (value, name, values) => setCustomInboundShippingAmount({
                  value: (values == null ? void 0 : values.value) || "",
                  float: (values == null ? void 0 : values.float) || null
                }),
                value: customInboundShippingAmount.value,
                disabled: !(inboundPreviewItems == null ? void 0 : inboundPreviewItems.length)
              }
            ) : getStylizedAmount(inboundShippingTotal, order.currency_code)
          ] })
        ] }),
        (0, import_jsx_runtime9.jsxs)("div", { className: "flex items-center justify-between", children: [
          (0, import_jsx_runtime9.jsx)("span", { className: "txt-small text-ui-fg-subtle", children: t2("orders.exchanges.outboundShipping") }),
          (0, import_jsx_runtime9.jsxs)("span", { className: "txt-small text-ui-fg-subtle flex items-center", children: [
            !isOutboundShippingPriceEdit && (0, import_jsx_runtime9.jsx)(
              IconButton,
              {
                onClick: () => setIsOutboundShippingPriceEdit(true),
                variant: "transparent",
                className: "text-ui-fg-muted",
                disabled: !(outboundPreviewItems == null ? void 0 : outboundPreviewItems.length) || !outboundShippingOptionId,
                children: (0, import_jsx_runtime9.jsx)(PencilSquare, {})
              }
            ),
            isOutboundShippingPriceEdit ? (0, import_jsx_runtime9.jsx)(
              CurrencyInput,
              {
                id: "js-outbound-shipping-input",
                onBlur: () => {
                  let actionId;
                  preview.shipping_methods.forEach((s) => {
                    if (s.actions) {
                      for (const a of s.actions) {
                        if (a.action === "SHIPPING_ADD" && !a.return_id) {
                          actionId = a.id;
                        }
                      }
                    }
                  });
                  const customPrice = customOutboundShippingAmount.float;
                  if (actionId) {
                    updateOutboundShipping(
                      {
                        actionId,
                        custom_amount: customPrice
                      },
                      {
                        onError: (error) => {
                          toast.error(error.message);
                        }
                      }
                    );
                  }
                  setIsOutboundShippingPriceEdit(false);
                },
                symbol: currencies[order.currency_code.toUpperCase()].symbol_native,
                code: order.currency_code,
                onValueChange: (value, name, values) => setCustomOutboundShippingAmount({
                  value: (values == null ? void 0 : values.value) || "",
                  float: (values == null ? void 0 : values.float) || null
                }),
                value: customOutboundShippingAmount.value,
                disabled: !(outboundPreviewItems == null ? void 0 : outboundPreviewItems.length)
              }
            ) : getStylizedAmount(
              outboundShippingTotal,
              order.currency_code
            )
          ] })
        ] }),
        (0, import_jsx_runtime9.jsxs)("div", { className: "mt-4 flex items-center justify-between border-t border-dotted pt-4", children: [
          (0, import_jsx_runtime9.jsx)("span", { className: "txt-small font-medium", children: t2("orders.exchanges.refundAmount") }),
          (0, import_jsx_runtime9.jsx)("span", { className: "txt-small font-medium", children: getStylizedAmount(
            preview.summary.pending_difference,
            order.currency_code
          ) })
        ] })
      ] }),
      (0, import_jsx_runtime9.jsx)("div", { className: "bg-ui-bg-field mt-8 rounded-lg border py-2 pl-2 pr-4", children: (0, import_jsx_runtime9.jsx)(
        Form.Field,
        {
          control: form.control,
          name: "send_notification",
          render: ({ field: { onChange, value, ...field } }) => {
            return (0, import_jsx_runtime9.jsxs)(Form.Item, { children: [
              (0, import_jsx_runtime9.jsxs)("div", { className: "flex items-center", children: [
                (0, import_jsx_runtime9.jsx)(Form.Control, { className: "mr-4 self-start", children: (0, import_jsx_runtime9.jsx)(
                  Switch,
                  {
                    className: "mt-[2px]",
                    checked: !!value,
                    onCheckedChange: onChange,
                    ...field
                  }
                ) }),
                (0, import_jsx_runtime9.jsxs)("div", { className: "block", children: [
                  (0, import_jsx_runtime9.jsx)(Form.Label, { children: t2("orders.returns.sendNotification") }),
                  (0, import_jsx_runtime9.jsx)(Form.Hint, { className: "!mt-1", children: t2("orders.returns.sendNotificationHint") })
                ] })
              ] }),
              (0, import_jsx_runtime9.jsx)(Form.ErrorMessage, {})
            ] });
          }
        }
      ) }),
      (0, import_jsx_runtime9.jsx)("div", { className: "p-8" })
    ] }) }),
    (0, import_jsx_runtime9.jsx)(RouteFocusModal.Footer, { children: (0, import_jsx_runtime9.jsx)("div", { className: "flex w-full items-center justify-end gap-x-4", children: (0, import_jsx_runtime9.jsxs)("div", { className: "flex items-center justify-end gap-x-2", children: [
      (0, import_jsx_runtime9.jsx)(RouteFocusModal.Close, { asChild: true, children: (0, import_jsx_runtime9.jsx)(
        Button,
        {
          type: "button",
          onClick: () => IS_CANCELING = true,
          variant: "secondary",
          size: "small",
          children: t2("orders.exchanges.cancel.title")
        }
      ) }),
      (0, import_jsx_runtime9.jsx)(
        Button,
        {
          type: "submit",
          variant: "primary",
          size: "small",
          isLoading: isRequestLoading,
          children: t2("orders.exchanges.confirm")
        },
        "submit-button"
      )
    ] }) }) })
  ] }) });
};
var IS_REQUEST_RUNNING = false;
var ExchangeCreate = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const { t: t2 } = useTranslation();
  const { order } = useOrder(id, {
    fields: DEFAULT_FIELDS
  });
  const { order: preview } = useOrderPreview(id);
  const [activeExchangeId, setActiveExchangeId] = (0, import_react.useState)();
  const { mutateAsync: createExchange } = useCreateExchange(order.id);
  const { exchange } = useExchange(activeExchangeId, void 0, {
    enabled: !!activeExchangeId
  });
  const { return: orderReturn } = useReturn(exchange == null ? void 0 : exchange.return_id, void 0, {
    enabled: !!(exchange == null ? void 0 : exchange.return_id)
  });
  (0, import_react.useEffect)(() => {
    async function run() {
      if (IS_REQUEST_RUNNING || !preview) {
        return;
      }
      if (preview.order_change) {
        if (preview.order_change.change_type === "exchange") {
          setActiveExchangeId(preview.order_change.exchange_id);
        } else {
          navigate(`/orders/${preview.id}`, { replace: true });
          toast.error(t2("orders.exchanges.activeChangeError"));
        }
        return;
      }
      IS_REQUEST_RUNNING = true;
      try {
        const { exchange: createdExchange } = await createExchange({
          order_id: preview.id
        });
        setActiveExchangeId(createdExchange.id);
      } catch (e) {
        toast.error(e.message);
        navigate(`/orders/${preview.id}`, { replace: true });
      } finally {
        IS_REQUEST_RUNNING = false;
      }
    }
    run();
  }, [preview]);
  return (0, import_jsx_runtime10.jsx)(RouteFocusModal, { children: exchange && preview && order && (0, import_jsx_runtime10.jsx)(
    ExchangeCreateForm,
    {
      order,
      exchange,
      preview,
      orderReturn
    }
  ) });
};
export {
  ExchangeCreate as Component
};
//# sourceMappingURL=order-create-exchange-AEMOZGTG-VQB55XNE.js.map
